---
title: "Load Data"
author: "Hunter Ratliff, @HunterRatliff1"
date: "March 27, 2016"
output: 
  html_document:
    theme: united
    highlight: zenburn
    toc: true
    toc_float: true
    code_folding: hide
---

This script requires the following packages. If this is your first time
using any of these packages, they will be installed from CRAN when you
run the line

```{r, collapse=TRUE}
if(!require(googlesheets)) install.packages("googlesheets")
if(!require(dplyr)) install.packages("dplyr")
if(!require(lubridate)) install.packages("lubridate")
if(!require(tidyr)) install.packages("tidyr")
if(!require(stringr)) install.packages("stringr")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(ggthemes)) install.packages("ggthemes")
if(!require(rio)) install.packages("rio")

knitr::opts_chunk$set(collapse=T)
```

Assuming that you've added the spreadsheet to your Google Drive,
call the spreadsheet by it's name, and select the appropriate sheet. If this
is your first time calling the function, you'll need to authenticate
your Google acount in the page that opens automatically in the browser

# Load parsed dataset
To begin, we'll grab the data from the *Parsed* sheet. This is the same as the report data,
but I've gone in and done some small formating adjustments. We'll save this as a data.frame 
as a RDS (`Parsed.RDS`) and load it into the enviroment as `Parsed`.

```{r, eval=FALSE}
gs_title("End of Shift Report") %>% gs_read_csv("Parsed") %>%
  
  # Remove this blank column (named BLANK)
  select(-BLANK) %>% 
  
  # Format the time sent (i.e. our primary key)
  mutate(
    Timestamp = floor_date(ymd_hms(Timestamp), "minute"), # Vector as POSIXct
    Time.Hour = hour(Timestamp)) %>%   # Get the hour the report was submitted
  export("Datasets/Parsed.RDS")
```

```{r, include=F}
Parsed <- import("Datasets/Parsed.RDS")
```

Below are the names of the `r ncol(Parsed)` columns generated by the report

```{r}
names(Parsed) 
```

***

# Create & save data.frames

Overall, we can "group" information into a few divisions:

1. **Names** - All these start with "Names_" + the dog's level. We'll include Panleuk kittens here too
2. **Numerical** - Number of dogs (overall & at each level), volunteers, discharges, etc.
3. **Inventory** - These are all checkboxes for medications and supplies
4. **Other** - The open ended questions at the end and everything else

We'll seperate these groups out into different data.frames, each of which will be 
saved in the "Datasets" directory by their names. For all data.frames, we'll use the 
*Timestamp* as the primary key.



> *Note:* Some of the responses are categorical variables that allow for multile selections.
They are stored as comma delimated list, which makes them hard to analyze. We'll use the
custom function below to create a nested data.frame of all the potential categories that could 
be selected as the columns, and each report summision as the rows.

> > We'll also import the lists of potential responses for each category from the Google Sheet

Define the custom function `cdl2D()`

```{r cdl2D}
cdl2D <- function(source.df, col="Vol2", ref.list="Vol2") {
  category.items <- ctgr.opts[ref.list] %>% unlist() %>% as.character()
  list.to.test <- source.df[col] %>% unlist() %>% as.character()
  
  # For each category that may be present in the list
  match.list <- category.items %>% lapply(function(x) stringr::str_detect(list.to.test, x))
  
  # Name the list with each poternral category
  names(match.list) <- category.items
  
  # Make data.frame and return
  match.df <- match.list %>% data.frame(check.names=F) %>% tbl_df()
  
  # if(!is.null(source.df$Timestamp)) match.df$Timestamp <- source.df$Timestamp
  return(match.df)
}
```

For each question, get the list of potential responses:

```{r ctgr.opts, eval=F}
# Read sheet with list of categorical vars
gs_title("End of Shift Report") %>% 
  gs_read_csv("categorical_vars")  %>%
  as.list() %>%
  lapply(unique) %>%
  saveRDS("Datasets/ctgr.opts.RDS")
```  

```{r}
ctgr.opts <- readRDS("Datasets/ctgr.opts.RDS")
```

## Names

```{r Names}
Names <- Parsed %>%
  select(
    Timestamp,
    Vols = Volunteers...Staff,
    Crt = Names_Crt,
    Int = Names_Int,
    Wel = Names_Wel,
    Dis = Names_Dis,
    New = Names_New,
    Dsc = Names_Dsc,
    Panleuk = Panleuk.Kittens) %>%
  mutate(
    Vols = str_replace_all(Vols, "\\.", ""),
    Vols = str_replace_all(Vols, "\\(+.+\\)", ""),
    Vols = str_replace(Vols, " training", ","),
    Vols = str_to_title(Vols))

# Save as CSV and RDS
Names %>% export("Datasets/Names.csv")

# Get unique volunteers as.char & save to ctgr.opts
ctgr.opts$Volunteers <- Names$Vols %>% str_split(", ") %>% unlist() %>% trimws() %>% unique() %>% as.character()

# Make nested data.frame
Names$Vols <- Names %>% cdl2D(col = "Vols", ref.list = "Volunteers")

# Save RDS
Names %>% export("Datasets/Names.RDS")
```

## Numerical

```{r Numerical}
Numerical <- Parsed %>%
  select(Timestamp,
         Dogs.in.ICU,
         Shift.Time,
         Count_Crt,
         Count_Int, 
         Count_Wel,
         Count_Dsc,
         Count_Dis, 
         Count_New)

# Number of volunteers
Numerical$Count_Vols <- Parsed$Volunteers...Staff  %>% stringr::str_count(pattern=",") + 1

# Save as CSV and RDS
Numerical %>% export("Datasets/Numerical.csv")
Numerical %>% export("Datasets/Numerical.RDS")
```

## Inventory

```{r Inventory}
Inventory <- Parsed %>%
  select(
    Timestamp,
    Invn.Supplies    = Inventory...Food...General.Supplies,
    Invn.MedSupplies = Inventory...Medical.Supplies,
    Invn.Medications = Inventory...Medications,
    Invn.Urgent      = Most.Urgent.Supplies.Needed
  )

# Save as CSV
Inventory %>% export("Datasets/Inventory.csv")

# Make nested data.frames
Inventory$Invn.Medications <- Inventory %>% cdl2D("Invn.Medications", "Medications")
Inventory$Invn.MedSupplies <- Inventory %>% cdl2D("Invn.MedSupplies", "MedSupplies")
Inventory$Invn.Supplies <- Inventory %>% cdl2D("Invn.Supplies", "Supplies")

# Save RDS
Inventory %>% export("Datasets/Inventory.RDS")
```

## Other

```{r Other}
Other <- Parsed %>%
  select(
    Timestamp,
    Vol2       = Have.you.logged.your.volunteer.hours.at.myvolunteerpage.com..,
    Dsc.Detail = Details_Dsc,
    Questions  = Any.Questions.,
    Additional = Additional.Information,
    Catheters  = Catheters.Placed.Replaced.
  )

# Save as CSV 
Other %>% export("Datasets/Other.csv")

# Make nested data.frame
Other$Vol2 <- Other %>% cdl2D(col = "Vol2", ref.list = "Vol2")

# Save RDS
Other %>% export("Datasets/Other.RDS")
```

# About

**Author:** `Hunter Ratliff` @[HunterRatliff1](https://twitter.com/HunterRatliff1)  

## License

```
--- LICENSE ---

Copyright (C) 2016 Hunter Ratliff

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
```

## Session Info

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

In the spirit of [Reproducible Research](https://cran.r-project.org/web/views/ReproducibleResearch.html),
below is the information About the R Session at the time it was compiled:

```{r Session_info, echo=TRUE, collapse=TRUE}
devtools::session_info()
```
